#!/bin/bash

set -euo pipefail

APP_ZIP_URL="https://github.com/alexkkork/install/raw/refs/heads/main/Snowflake%20UI%202.zip%20alias"
APP_NAME="Snowflake UI 2.app"
APP_BASENAME="Snowflake UI 2"
TMP_DIR=$(mktemp -d)

echo "❄️  Snowflake UI 2 Installer"
echo "==========================="
echo "🧼 Removing old versions..."

# Define common locations to check
POSSIBLE_LOCATIONS=(
  "/Applications"
  "$HOME/Applications"
  "$HOME/Desktop"
  "$HOME/Downloads"
)

# Remove matching .app folders from locations
for loc in "${POSSIBLE_LOCATIONS[@]}"; do
  find "$loc" -maxdepth 1 -type d -name "$APP_BASENAME*" -exec rm -rf {} +
done

# Also check recursively in /Applications in case of odd installs
find /Applications -type d -name "$APP_BASENAME*.app" -exec rm -rf {} + 2>/dev/null || true

echo "📦 Downloading latest version..."
curl -L "$APP_ZIP_URL" -o "$TMP_DIR/app.zip"

echo "🧩 Unpacking archive..."
unzip -q "$TMP_DIR/app.zip" -d "$TMP_DIR"

# Locate the .app in unpacked folder
APP_PATH=$(find "$TMP_DIR" -type d -name "*.app" | head -n 1)
if [[ ! -d "$APP_PATH" ]]; then
    echo "❌ App not found in zip. Exiting."
    rm -rf "$TMP_DIR"
    exit 1
fi

echo "📁 Installing to /Applications..."
mv "$APP_PATH" "/Applications/"

# Extract app name from found path
FINAL_APP_NAME=$(basename "$APP_PATH")

echo "🚀 Launching $FINAL_APP_NAME..."
open -a "/Applications/$FINAL_APP_NAME"

echo "✅ Installation complete!"
echo "🧊 Enjoy Snowflake UI 2."

# Cleanup
rm -rf "$TMP_DIR"
